---
- name: Deploy CoBank Cloud Platform
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    frontend_repo: cobank-frontend
    backend_repo: cobank-backend

  tasks:

    ###########################################################################
    # 0. Validate required variables
    ###########################################################################
    - name: Ensure required variables are defined
      assert:
        that:
          - aws_region is defined
          - cluster_name is defined
          - app_namespace is defined
        fail_msg: "One or more required variables are not defined: aws_region, cluster_name, app_namespace"

    ###########################################################################
    # 1. SOURCE OF TRUTH â€“ GIT + IMAGE TAGGING
    ###########################################################################
    - name: Ensure running inside a Git repository
      command: git rev-parse --is-inside-work-tree
      register: git_check
      failed_when: git_check.rc != 0
      changed_when: false

    - name: Get Git commit hash (short)
      command: git rev-parse --short HEAD
      register: git_commit
      changed_when: false

    - name: Set immutable image tag
      set_fact:
        image_tag: "{{ git_commit.stdout }}"

    - name: Validate image tag
      assert:
        that:
          - image_tag is defined
          - image_tag | length > 0
        fail_msg: "Unable to determine image tag from Git"

    ###########################################################################
    # 2. AWS & ECR CONFIGURATION
    ###########################################################################
    - name: Get AWS Account ID
      command: aws sts get-caller-identity --query Account --output text
      register: aws_account_id
      changed_when: false

    - name: Set ECR account_id and registry
      set_fact:
        account_id: "{{ aws_account_id.stdout }}"
        ecr_registry: "{{ aws_account_id.stdout }}.dkr.ecr.{{ aws_region }}.amazonaws.com"

    - name: Set frontend and backend image paths
      set_fact:
        frontend_image: "{{ ecr_registry }}/{{ frontend_repo }}:{{ image_tag }}"
        backend_image: "{{ ecr_registry }}/{{ backend_repo }}:{{ image_tag }}"


    - name: Ensure ECR repositories exist
      shell: |
        aws ecr describe-repositories \
          --repository-names {{ item }} \
          --region {{ aws_region }} || \
        aws ecr create-repository \
          --repository-name {{ item }} \
          --region {{ aws_region }}
      loop:
        - "{{ frontend_repo }}"
        - "{{ backend_repo }}"
      changed_when: false

    - name: Authenticate Docker to Amazon ECR
      shell: |
        aws ecr get-login-password --region "{{ aws_region }}" \
        | docker login --username AWS --password-stdin "{{ ecr_registry }}"
      environment:
        AWS_DEFAULT_REGION: "{{ aws_region }}"
      no_log: true

    ###########################################################################
    # 3. BUILD CONTAINER IMAGES
    ###########################################################################
    - name: Build frontend image
      docker_image:
        name: "{{ frontend_repo }}"
        tag: "{{ image_tag }}"
        source: build
        build:
          path: "{{ playbook_dir }}/../apps/frontend"
          pull: yes

    - name: Build backend image
      docker_image:
        name: "{{ backend_repo }}"
        tag: "{{ image_tag }}"
        source: build
        build:
          path: "{{ playbook_dir }}/../apps/backend"
          pull: yes

    ###########################################################################
    # 4. SECURITY SCANNING (FAIL FAST)
    ###########################################################################
    - name: Trivy scan frontend image (HIGH / CRITICAL)
      command: >
        docker run --rm
        -v /var/run/docker.sock:/var/run/docker.sock
        aquasec/trivy
        image --no-progress --severity HIGH,CRITICAL
        {{ frontend_repo }}:{{ image_tag }}
      register: trivy_frontend
      failed_when: trivy_frontend.rc != 0

    - name: Trivy scan backend image (HIGH / CRITICAL)
      command: >
        docker run --rm
        -v /var/run/docker.sock:/var/run/docker.sock
        aquasec/trivy
        image --no-progress --severity HIGH,CRITICAL
        {{ backend_repo }}:{{ image_tag }}
      register: trivy_backend
      failed_when: trivy_backend.rc != 0

    ###########################################################################
    # 5. TAG & PUSH IMAGES (IMMUTABLE + LATEST)
    ###########################################################################
    - name: Tag and push frontend image
      shell: |
        docker tag {{ frontend_repo }}:{{ image_tag }} {{ frontend_image }}
        docker tag {{ frontend_repo }}:{{ image_tag }} {{ ecr_registry }}/{{ frontend_repo }}:latest
        docker push {{ frontend_image }}
        docker push {{ ecr_registry }}/{{ frontend_repo }}:latest

    - name: Tag and push backend image
      shell: |
        docker tag {{ backend_repo }}:{{ image_tag }} {{ backend_image }}
        docker tag {{ backend_repo }}:{{ image_tag }} {{ ecr_registry }}/{{ backend_repo }}:latest
        docker push {{ backend_image }}
        docker push {{ ecr_registry }}/{{ backend_repo }}:latest

    ###########################################################################
    # 6. KUBERNETES DEPLOYMENT (EKS + ISTIO)
    ###########################################################################
    - name: Update kubeconfig for EKS
      command: aws eks update-kubeconfig --name {{ cluster_name }} --region {{ aws_region }}
      changed_when: false

    - name: Apply Kubernetes manifests
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', item) | from_yaml_all }}"
      loop:
        - "{{ playbook_dir }}/../k8s/base/namespace.yaml"
        - "{{ playbook_dir }}/../k8s/base/frontend-deployment.yaml"
        - "{{ playbook_dir }}/../k8s/base/backend-deployment.yaml"
        - "{{ playbook_dir }}/../k8s/base/services.yaml"
        - "{{ playbook_dir }}/../k8s/base/hpa.yaml"
        - "{{ playbook_dir }}/../k8s/istio/gateway.yaml"
        - "{{ playbook_dir }}/../k8s/istio/virtualservice.yaml"

    - name: Patch backend deployment image to ECR tag
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: backend
            namespace: "{{ app_namespace }}"
          spec:
            template:
              spec:
                containers:
                  - name: backend
                    image: "{{ backend_image }}"

    - name: Patch frontend deployment image to ECR tag
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: frontend
            namespace: "{{ app_namespace }}"
          spec:
            template:
              spec:
                containers:
                  - name: frontend
                    image: "{{ frontend_image }}"

    ###########################################################################
    # 7. HEALTH CHECKS
    ###########################################################################
    - name: Wait for frontend pods to be running
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ app_namespace }}"
        label_selectors:
          - app=frontend
      register: frontend_pods
      until: >
        frontend_pods.resources | length > 0 and
        frontend_pods.resources
        | selectattr('status.phase','equalto','Running')
        | list | length == frontend_pods.resources | length
      retries: 60
      delay: 10

    - name: Wait for backend pods to be running
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ app_namespace }}"
        label_selectors:
          - app=backend
      register: backend_pods
      until: >
        backend_pods.resources | length > 0 and
        backend_pods.resources
        | selectattr('status.phase','equalto','Running')
        | list | length == backend_pods.resources | length
      retries: 60
      delay: 10

    ###########################################################################
    # 8. OPTIONAL: ARGO CD SYNC (GITOPS)
    ###########################################################################
    - name: Trigger ArgoCD sync
      uri:
        url: "https://{{ argocd_server }}/api/v1/applications/{{ argocd_app_name }}/sync"
        method: POST
        headers:
          Authorization: "Bearer {{ lookup('env','ARGOCD_TOKEN') | default('') }}"
        body_format: json
        body:
          prune: true
          dryRun: false
        validate_certs: no
        status_code: 200
      ignore_errors: yes

    ###########################################################################
    # 9. FINAL STATUS
    ###########################################################################
    - name: Deployment summary
      debug:
        msg: |
          ðŸŽ‰ CoBank Cloud Platform Deployed Successfully

          Git Commit: {{ image_tag }}
          Frontend Image: {{ frontend_image }}
          Backend Image: {{ backend_image }}

          Access:
          - Local: docker compose up
          - EKS: kubectl port-forward svc/istio-ingressgateway 8081:80 -n istio-system
