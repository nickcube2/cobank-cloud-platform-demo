---
- name: Fail if not in Git repository
  assert:
    that: image_tag != ""
    fail_msg: "Not in a Git repository â€“ cannot determine image tag"

- name: Get AWS Account ID
  command: aws sts get-caller-identity --query Account --output text
  register: aws_account
  changed_when: false

- name: Set ECR facts
  set_fact:
    account_id: "{{ aws_account.stdout }}"
    ecr_registry: "{{ aws_account.stdout }}.dkr.ecr.{{ aws_region }}.amazonaws.com"
    frontend_image: "{{ ecr_registry }}/{{ frontend_repo }}:{{ image_tag }}"
    backend_image: "{{ ecr_registry }}/{{ backend_repo }}:{{ image_tag }}"

- name: ECR Login
  command: >
    aws ecr get-login-password --region {{ aws_region }} |
    docker login --username AWS --password-stdin {{ ecr_registry }}
  no_log: true

- name: Process Frontend Image
  block:
    - name: Build frontend image with cache
      docker_image:
        name: "{{ frontend_repo }}"
        tag: "{{ image_tag }}"
        build:
          path: "{{ playbook_dir }}/../../apps/frontend"
          pull: yes
          cache_from:
            - "{{ frontend_repo }}:latest"
        source: build

    - name: Trivy scan frontend
      command: docker run --rm aquasec/trivy image --exit-code 1 --no-progress --severity HIGH,CRITICAL {{ frontend_repo }}:{{ image_tag }}

    - name: Tag and push frontend
      shell: |
        docker tag {{ frontend_repo }}:{{ image_tag }} {{ frontend_image }}
        docker tag {{ frontend_repo }}:{{ image_tag }} {{ ecr_registry }}/{{ frontend_repo }}:latest
        docker push {{ frontend_image }}
        docker push {{ ecr_registry }}/{{ frontend_repo }}:latest
  tags: frontend

- name: Process Backend Image
  block:
    - name: Build backend image with cache
      docker_image:
        name: "{{ backend_repo }}"
        tag: "{{ image_tag }}"
        build:
          path: "{{ playbook_dir }}/../../apps/backend"
          pull: yes
          cache_from:
            - "{{ backend_repo }}:latest"
        source: build

    - name: Trivy scan backend
      command: docker run --rm aquasec/trivy image --exit-code 1 --no-progress --severity HIGH,CRITICAL {{ backend_repo }}:{{ image_tag }}

    - name: Tag and push backend
      shell: |
        docker tag {{ backend_repo }}:{{ image_tag }} {{ backend_image }}
        docker tag {{ backend_repo }}:{{ image_tag }} {{ ecr_registry }}/{{ backend_repo }}:latest
        docker push {{ backend_image }}
        docker push {{ ecr_registry }}/{{ backend_repo }}:latest
  tags: backend

- name: Update kubeconfig
  command: aws eks update-kubeconfig --name {{ cluster_name }} --region {{ aws_region }}
  changed_when: false

- name: Apply Kubernetes manifests
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('file', item) | from_yaml_all }}"
  loop:
    - "{{ playbook_dir }}/../../k8s/base/namespace.yaml"
    - "{{ playbook_dir }}/../../k8s/base/frontend-deployment.yaml"
    - "{{ playbook_dir }}/../../k8s/base/backend-deployment.yaml"
    - "{{ playbook_dir }}/../../k8s/base/services.yaml"
    - "{{ playbook_dir }}/../../k8s/base/hpa.yaml"
    - "{{ playbook_dir }}/../../k8s/istio/gateway.yaml"
    - "{{ playbook_dir }}/../../k8s/istio/virtualservice.yaml"

- name: Wait for frontend rollout
  kubernetes.core.k8s_rollout_status:
    api_version: apps/v1
    kind: Deployment
    name: frontend
    namespace: "{{ app_namespace }}"
    timeout: 300

- name: Trigger ArgoCD sync
  uri:
    url: "https://{{ argocd_server }}/api/v1/applications/{{ argocd_app_name }}/sync"
    method: POST
    headers:
      Authorization: "Bearer {{ lookup('env', 'ARGOCD_TOKEN') | default('') }}"
    body_format: json
    body: '{"prune": true}'
    validate_certs: no
    status_code: 200
  ignore_errors: yes

- name: Deployment Complete
  debug:
    msg: |
      ðŸŽ‰ CoBank platform deployed successfully!
      Image tag: {{ image_tag }}
      Frontend: {{ frontend_image }}
      Backend: {{ backend_image }}
      Access your beautiful CoBank homepage via Istio gateway!